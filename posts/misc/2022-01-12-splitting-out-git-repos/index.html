<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>Split out a Git Repo and Keep it's Commit History | Michael Thornton</title>
<meta name=keywords content="git,misc">
<meta name=description content="One thing I&rsquo;ve been tasked with working on recently is splitting out microservices from a monorepo into their own separate repos. While this may sound trivial, one thing that is essential is to keep the git history associated with these services - which is more complicated than it looks. There&rsquo;s a native tool built into git, git filter-branch - but it is quite finicky.
Thankfully, a tool exists which offers a one command solution - git filter repo.">
<meta name=author content="Michael Thornton">
<link rel=canonical href=https://thorntonmc.github.io/posts/misc/2022-01-12-splitting-out-git-repos/>
<link crossorigin=anonymous href=/assets/css/stylesheet.min.c88963fe2d79462000fd0fb1b3737783c32855d340583e4523343f8735c787f0.css integrity="sha256-yIlj/i15RiAA/Q+xs3N3g8MoVdNAWD5FIzQ/hzXHh/A=" rel="preload stylesheet" as=style>
<script defer crossorigin=anonymous src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://thorntonmc.github.io/favicon.ico>
<link rel=icon type=image/png sizes=16x16 href=https://thorntonmc.github.io/favicon-16x16.png>
<link rel=icon type=image/png sizes=32x32 href=https://thorntonmc.github.io/favicon-32x32.png>
<link rel=apple-touch-icon href=https://thorntonmc.github.io/apple-touch-icon.png>
<link rel=mask-icon href=https://thorntonmc.github.io/safari-pinned-tab.svg>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<meta name=generator content="Hugo 0.92.0">
<link rel=alternate hreflang=en href=https://thorntonmc.github.io/posts/misc/2022-01-12-splitting-out-git-repos/>
<noscript>
<style>#theme-toggle,.top-link{display:none}</style>
</noscript><meta property="og:title" content="Split out a Git Repo and Keep it's Commit History">
<meta property="og:description" content="One thing I&rsquo;ve been tasked with working on recently is splitting out microservices from a monorepo into their own separate repos. While this may sound trivial, one thing that is essential is to keep the git history associated with these services - which is more complicated than it looks. There&rsquo;s a native tool built into git, git filter-branch - but it is quite finicky.
Thankfully, a tool exists which offers a one command solution - git filter repo.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://thorntonmc.github.io/posts/misc/2022-01-12-splitting-out-git-repos/"><meta property="og:image" content="https://thorntonmc.github.io/papermod-cover.png"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2022-01-12T00:00:00+00:00">
<meta property="article:modified_time" content="2022-01-12T00:00:00+00:00">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://thorntonmc.github.io/papermod-cover.png">
<meta name=twitter:title content="Split out a Git Repo and Keep it's Commit History">
<meta name=twitter:description content="One thing I&rsquo;ve been tasked with working on recently is splitting out microservices from a monorepo into their own separate repos. While this may sound trivial, one thing that is essential is to keep the git history associated with these services - which is more complicated than it looks. There&rsquo;s a native tool built into git, git filter-branch - but it is quite finicky.
Thankfully, a tool exists which offers a one command solution - git filter repo.">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://thorntonmc.github.io/posts/"},{"@type":"ListItem","position":3,"name":"Split out a Git Repo and Keep it's Commit History","item":"https://thorntonmc.github.io/posts/misc/2022-01-12-splitting-out-git-repos/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Split out a Git Repo and Keep it's Commit History","name":"Split out a Git Repo and Keep it\u0027s Commit History","description":"One thing I\u0026rsquo;ve been tasked with working on recently is splitting out microservices from a monorepo into their own separate repos. While this may sound trivial, one thing that is essential is to keep the git history associated with these services - which is more complicated than it looks. There\u0026rsquo;s a native tool built into git, git filter-branch - but it is quite finicky.\nThankfully, a tool exists which offers a one command solution - git filter repo.","keywords":["git","misc"],"articleBody":"One thing Iâ€™ve been tasked with working on recently is splitting out microservices from a monorepo into their own separate repos. While this may sound trivial, one thing that is essential is to keep the git history associated with these services - which is more complicated than it looks. Thereâ€™s a native tool built into git, git filter-branch - but it is quite finicky.\nThankfully, a tool exists which offers a one command solution - git filter repo. In fact, the man page for git filter-branch even recommends it be used as the tool of choice.\nA Note for MacOS Users You may receive an error such as\nfatal: cannot lock ref 'refs/heads/branchname': Unable to create '/Users/your_user_name/your_repo/.git/refs/heads/your_branch.lock': File exists. Another git process seems to be running in this repository, e.g. an editor opened by 'git commit'. Please make sure all processes are terminated then try again. If it still fails, a git process may have crashed in this repository earlier: remove the file manually to continue. git update-ref failed; see above For me, this was because there were two branches with the same name, but with different casing. Since MacOS ships with a default of a non-case sensitive filesystem, I needed to run this in a Linux VM.\nPrerequisites Per the docs, git filter-repo requires:\n git = 2.22.0 at a minimum; some features require git = 2.24.0 or later\n However, I just updated to the newest version of git. If you canâ€™t update to this natively (I had issues on Ubuntu 18.04), you can do the following:\nsudo add-apt-repository ppa:git-core/ppa sudo apt update sudo apt install git Next, install git filter repo - if youâ€™re on macOS you can simply brew install git filter repo, if youâ€™re on Linux, depending on your distro, you may have to build from source - hereâ€™s a slightly modified version of the instructions taken from the INSTALL.md\ngit clone https://github.com/newren/git-filter-repo cd git-filter-repo cp -a git-filter-repo $(git --exec-path) cp -a git-filter-repo.1 $(git --man-path)/man1 \u0026\u0026 mandb cp -a git-filter-repo.html $(git --html-path) ln -s $(git --exec-path)/git-filter-repo \\ $(python -c \"import site; print(site.getsitepackages()[-1])\")/git_filter_repo.py Performing The Initial Split First, I recommend cloning a fresh copy of your repo as we donâ€™t want to mess up any version you may actually be working in\ngit clone https://github.com/${your_repo} -o your_repo_filter_clone Next, in the freshly cloned repo, you can simply run\ngit filter-repo --subdirectory-filter ${/YOUR/BROKEN/OUT/DIR} This command takes everything in /your/broken/out/dir, puts it in the root directory, rewriting the commits so that the only thing that now exists in this repo are the contents of the directory, along with only the commit history of that directory. Neat!\nNow all thatâ€™s left to do is set up your remote instance, but before we do thatâ€¦\nIf you need to rename directories Itâ€™s best to do this before committing anything to remote repositories â€“ you can do this by simply using\ngit filter-repo --path-rename ${original_path}:${new_path} For example, as I break out these microservices, Iâ€™d like to restructure them according to the standard go project layout - hereâ€™s an instance of me renaming the app directory to what should be the internal directory:\ngit filter-repo --path-rename app/my-app.go:internal/my-app.go This renames, and rewrites the history for app/smoke-test.go under internal/smoke-test.go\nSyncing your new repo back to the remote To sync the repo back to GitHub, or whatever youâ€™re using, you can simply set the remote. git filter-repo removes the remote origin, so you shouldnâ€™t be able to commit back to the repo you cloned it from by accident:\n git remote add origin https://github.com/${YOUR_ORG}/${YOUR_NEW_REPO}.git git branch -M main git push ","wordCount":"591","inLanguage":"en","datePublished":"2022-01-12T00:00:00Z","dateModified":"2022-01-12T00:00:00Z","author":{"@type":"Person","name":"Michael Thornton"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://thorntonmc.github.io/posts/misc/2022-01-12-splitting-out-git-repos/"},"publisher":{"@type":"Organization","name":"Michael Thornton","logo":{"@type":"ImageObject","url":"https://thorntonmc.github.io/favicon.ico"}}}</script>
</head>
<body id=top>
<script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add('dark')</script>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://thorntonmc.github.io accesskey=h title="Michael Thornton (Alt + H)">Michael Thornton</a>
<span class=logo-switches>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
<ul class=lang-switch><li>|</li>
<li>
<a href=https://thorntonmc.github.io/tr/ title=Turkish aria-label=:tr:>ðŸ‡¹ðŸ‡·</a>
</li>
</ul>
</span>
</div>
<ul id=menu>
<li>
<a href=https://thorntonmc.github.io/archives title=Archive>
<span>Archive</span>
</a>
</li>
<li>
<a href=https://thorntonmc.github.io/categories/ title=Categories>
<span>Categories</span>
</a>
</li>
<li>
<a href=https://thorntonmc.github.io/search/ title="Search (Alt + /)" accesskey=/>
<span>Search</span>
</a>
</li>
<li>
<a href=https://thorntonmc.github.io/tags/ title=Tags>
<span>Tags</span>
</a>
</li>
</ul>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<div class=breadcrumbs><a href=https://thorntonmc.github.io>Home</a>&nbsp;Â»&nbsp;<a href=https://thorntonmc.github.io/posts/>Posts</a></div>
<h1 class=post-title>
Split out a Git Repo and Keep it's Commit History
</h1>
<div class=post-meta><span title="2022-01-12 00:00:00 +0000 UTC">January 12, 2022</span>&nbsp;Â·&nbsp;3 min&nbsp;Â·&nbsp;Michael Thornton&nbsp;|&nbsp;<a href=https://github.com/thorntonmc/thorntonmc.github.io/tree/main/content/posts/misc/2022-01-12-splitting-out-git-repos.md rel="noopener noreferrer" target=_blank>Suggest Changes</a>
</div>
</header> <div class=toc>
<details>
<summary accesskey=c title="(Alt + C)">
<span class=details>Table of Contents</span>
</summary>
<div class=inner><ul>
<li>
<a href=#a-note-for-macos-users aria-label="A Note for MacOS Users">A Note for MacOS Users</a></li>
<li>
<a href=#prerequisites aria-label=Prerequisites>Prerequisites</a></li>
<li>
<a href=#performing-the-initial-split aria-label="Performing The Initial Split">Performing The Initial Split</a></li>
<li>
<a href=#if-you-need-to-rename-directories aria-label="If you need to rename directories">If you need to rename directories</a></li>
<li>
<a href=#syncing-your-new-repo-back-to-the-remote aria-label="Syncing your new repo back to the remote">Syncing your new repo back to the remote</a>
</li>
</ul>
</div>
</details>
</div>
<div class=post-content><p>One thing I&rsquo;ve been tasked with working on recently is splitting out microservices from a monorepo into their own separate repos. While this may sound trivial, one thing that is essential is to keep the git history associated with these services - which is more complicated than it looks. There&rsquo;s a native tool built into git, <code>git filter-branch</code> - but it is quite finicky.</p>
<p>Thankfully, a tool exists which offers a one command solution - <a href=https://github.com/newren/git-filter-repo>git filter repo</a>. In fact, the <a href=https://git-scm.com/docs/git-filter-branch>man page for git filter-branch</a> even recommends it be used as the tool of choice.</p>
<h3 id=a-note-for-macos-users>A Note for MacOS Users<a hidden class=anchor aria-hidden=true href=#a-note-for-macos-users>#</a></h3>
<p>You may receive an error such as</p>
<pre tabindex=0><code>fatal: cannot lock ref 'refs/heads/branchname': Unable to create '/Users/your_user_name/your_repo/.git/refs/heads/your_branch.lock': File exists.

Another git process seems to be running in this repository, e.g.
an editor opened by 'git commit'. Please make sure all processes
are terminated then try again. If it still fails, a git process
may have crashed in this repository earlier:
remove the file manually to continue.
git update-ref failed; see above
</code></pre><p>For me, this was because there were two branches with the <a href=https://github.com/newren/git-filter-repo/issues/48>same name, but with different casing</a>. Since MacOS ships with a default of a non-case sensitive filesystem, I needed to run this in a Linux VM.</p>
<h3 id=prerequisites>Prerequisites<a hidden class=anchor aria-hidden=true href=#prerequisites>#</a></h3>
<p>Per the docs, <code>git filter-repo</code> requires:</p>
<blockquote>
<p>git >= 2.22.0 at a minimum; some features require git >= 2.24.0 or later</p>
</blockquote>
<p>However, I just updated to the newest version of git. If you can&rsquo;t update to this natively (I had issues on Ubuntu 18.04), you can do the following:</p>
<pre tabindex=0><code>sudo add-apt-repository ppa:git-core/ppa
sudo apt update
sudo apt install git
</code></pre><p>Next, install <code>git filter repo</code> - if you&rsquo;re on macOS you can simply <code>brew install git filter repo</code>, if you&rsquo;re on Linux, depending on your distro, you may have to <a href=https://github.com/newren/git-filter-repo/blob/main/INSTALL.md>build from source</a> - here&rsquo;s a slightly modified version of the instructions taken from the <code>INSTALL.md</code></p>
<pre tabindex=0><code>git clone https://github.com/newren/git-filter-repo
cd git-filter-repo
cp -a git-filter-repo $(git --exec-path)
cp -a git-filter-repo.1 $(git --man-path)/man1 &amp;&amp; mandb
cp -a git-filter-repo.html $(git --html-path)
ln -s $(git --exec-path)/git-filter-repo \
    $(python -c &quot;import site; print(site.getsitepackages()[-1])&quot;)/git_filter_repo.py
</code></pre><h3 id=performing-the-initial-split>Performing The Initial Split<a hidden class=anchor aria-hidden=true href=#performing-the-initial-split>#</a></h3>
<p>First, I recommend cloning a fresh copy of your repo as we don&rsquo;t want to mess up any version you may actually be working in</p>
<pre tabindex=0><code>git clone https://github.com/${your_repo} -o your_repo_filter_clone
</code></pre><p>Next, in the freshly cloned repo, you can simply run</p>
<pre tabindex=0><code>git filter-repo --subdirectory-filter ${/YOUR/BROKEN/OUT/DIR}
</code></pre><p>This command takes everything in <code>/your/broken/out/dir</code>, puts it in the root directory, rewriting the commits so that the only thing that now exists in this repo are the contents of the directory, along with <em>only</em> the commit history of that directory. Neat!</p>
<p>Now all that&rsquo;s left to do is set up your remote instance, but before we do that&mldr;</p>
<h3 id=if-you-need-to-rename-directories>If you need to rename directories<a hidden class=anchor aria-hidden=true href=#if-you-need-to-rename-directories>#</a></h3>
<p>Itâ€™s best to do this before committing anything to remote repositories â€“ you can do this by simply using</p>
<pre tabindex=0><code>git filter-repo --path-rename ${original_path}:${new_path}
</code></pre><p>For example, as I break out these microservices, I&rsquo;d like to restructure them according to the <a href=https://github.com/golang-standards/project-layout>standard go project layout</a> - here&rsquo;s an instance of me renaming the <code>app</code> directory to what should be the <code>internal</code> directory:</p>
<pre tabindex=0><code>git filter-repo --path-rename app/my-app.go:internal/my-app.go
</code></pre><p>This renames, and rewrites the history for app/smoke-test.go under internal/smoke-test.go</p>
<h3 id=syncing-your-new-repo-back-to-the-remote>Syncing your new repo back to the remote<a hidden class=anchor aria-hidden=true href=#syncing-your-new-repo-back-to-the-remote>#</a></h3>
<p>To sync the repo back to GitHub, or whatever you&rsquo;re using, you can simply set the remote. <code>git filter-repo</code> removes the remote origin, so you shouldn&rsquo;t be able to commit back to the repo you cloned it from by accident:</p>
<pre tabindex=0><code> git remote add origin https://github.com/${YOUR_ORG}/${YOUR_NEW_REPO}.git
 git branch -M main
 git push
</code></pre>
</div>
<footer class=post-footer>
<ul class=post-tags>
<li><a href=https://thorntonmc.github.io/tags/git/>git</a></li>
<li><a href=https://thorntonmc.github.io/tags/misc/>misc</a></li>
</ul>
<nav class=paginav>
<a class=prev href=https://thorntonmc.github.io/posts/go/2022-01-17-net-http/>
<span class=title>Â« Prev Page</span>
<br>
<span>Reading the Go Standard Library - net/http</span>
</a>
<a class=next href=https://thorntonmc.github.io/posts/sre-challenge/2022-01-09-sre-challenge/>
<span class=title>Next Page Â»</span>
<br>
<span>A Reddit SRE Challenge - Part 1</span>
</a>
</nav>
</footer>
</article>
</main>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a>
<script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
<script>document.querySelectorAll('pre > code').forEach(b=>{const c=b.parentNode.parentNode,a=document.createElement('button');a.classList.add('copy-code'),a.innerText='copy';function d(){a.innerText='copied!',setTimeout(()=>{a.innerText='copy'},2e3)}a.addEventListener('click',e=>{if('clipboard'in navigator){navigator.clipboard.writeText(b.textContent),d();return}const a=document.createRange();a.selectNodeContents(b);const c=window.getSelection();c.removeAllRanges(),c.addRange(a);try{document.execCommand('copy'),d()}catch(a){}c.removeRange(a)}),c.classList.contains("highlight")?c.appendChild(a):c.parentNode.firstChild==c||(b.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?b.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(a):b.parentNode.appendChild(a))})</script>
</body>
</html>